#include <iostream>
#include <algorithm> // For min() function
#include "InGameState.h"
#include "MainMenuState.h"
#include "LoadGameState.h"
#include "GameEngine.h"
#include "game/SaveSystem.h"
#include <optional>
#include <SFML/Window/Event.hpp>

using namespace std;

// Helper to convert std::string (UTF-8) to sf::String
sf::String to_sf_string_ingame(const std::string& s) {
    return sf::String::fromUtf8(s.begin(), s.end());
}

InGameState::InGameState(GameEngine& game)
    : GameState(game),
      dialogueVisitor(game.getWindow()),
      currentDialogueNode(nullptr),
      currentNodeId("root"),
      showMenu(false),
      hoveredButton(-1) {
    cout << "InGameState constructor start" << endl;

    // Load UI font
    if (!uiFont.openFromFile("assets/arial.ttf")) {
        cerr << "Error loading UI font" << endl;
    }

    // Create text objects with font
    saveButtonText = new sf::Text(uiFont);
    loadButtonText = new sf::Text(uiFont);
    exitButtonText = new sf::Text(uiFont);
    backButtonText = new sf::Text(uiFont);

    // Initialize UI buttons (positioned at top right)
    sf::Vector2u windowSize = game.getWindow().getSize();
    float buttonWidth = 80.0f;
    float buttonHeight = 35.0f;
    float buttonMargin = 10.0f;
    float topMargin = 10.0f;

    // Back button (leftmost) - Uses Stack for undo
    backButton.setSize({buttonWidth, buttonHeight});
    backButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 4, topMargin});
    backButton.setFillColor(sf::Color(100, 80, 140, 200));
    backButton.setOutlineColor(sf::Color(150, 120, 200));
    backButton.setOutlineThickness(2);

    backButtonText->setString(to_sf_string_ingame("Back"));
    backButtonText->setCharacterSize(18);
    backButtonText->setFillColor(sf::Color::White);
    backButtonText->setPosition({backButton.getPosition().x + 20, backButton.getPosition().y + 7});

    // Save button
    saveButton.setSize({buttonWidth, buttonHeight});
    saveButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 3, topMargin});
    saveButton.setFillColor(sf::Color(60, 100, 140, 200));
    saveButton.setOutlineColor(sf::Color(100, 150, 200));
    saveButton.setOutlineThickness(2);

    saveButtonText->setString(to_sf_string_ingame("Save"));
    saveButtonText->setCharacterSize(18);
    saveButtonText->setFillColor(sf::Color::White);
    saveButtonText->setPosition({saveButton.getPosition().x + 20, saveButton.getPosition().y + 7});

    // Load button
    loadButton.setSize({buttonWidth, buttonHeight});
    loadButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 2, topMargin});
    loadButton.setFillColor(sf::Color(60, 100, 140, 200));
    loadButton.setOutlineColor(sf::Color(100, 150, 200));
    loadButton.setOutlineThickness(2);

    loadButtonText->setString(to_sf_string_ingame("Load"));
    loadButtonText->setCharacterSize(18);
    loadButtonText->setFillColor(sf::Color::White);
    loadButtonText->setPosition({loadButton.getPosition().x + 20, loadButton.getPosition().y + 7});

    // Exit button
    exitButton.setSize({buttonWidth, buttonHeight});
    exitButton.setPosition({windowSize.x - (buttonWidth + buttonMargin), topMargin});
    exitButton.setFillColor(sf::Color(140, 60, 60, 200));
    exitButton.setOutlineColor(sf::Color(200, 100, 100));
    exitButton.setOutlineThickness(2);

    exitButtonText->setString(to_sf_string_ingame("Exit"));
    exitButtonText->setCharacterSize(18);
    exitButtonText->setFillColor(sf::Color::White);
    exitButtonText->setPosition({exitButton.getPosition().x + 23, exitButton.getPosition().y + 7});

    // Apply text speed from settings
    dialogueVisitor.setTextSpeed(game.getSettings().getTextSpeedMultiplier());
    dialogueVisitor.setPlayer(&game.getPlayer());

    auto* dialogueGraph = game.getDialogueGraph();
    if (dialogueGraph) {
        dialogueGraph->setDialogueStartCallback([this](NTree<Dialogue, MAX_CHOICES>* node) {
            cout << "Dialogue start callback" << endl;
            if (node && !node->isEmpty()) {
                currentDialogueNode = node;
                currentDialogueNode->getKey().accept(dialogueVisitor);
            } else {
                currentDialogueNode = nullptr;
            }
        });

        auto* rootNode = dialogueGraph->buildTree();
        cout << "Tree built" << endl;
        if (rootNode) {
            game.getPlayer().displayStatus();
            if (rootNode && !rootNode->isEmpty()) {
                currentDialogueNode = rootNode;
                cout << "Accepting visitor" << endl;
                currentDialogueNode->getKey().accept(dialogueVisitor);
                cout << "Visitor accepted" << endl;
            } else {
                currentDialogueNode = nullptr;
            }
        } else {
            cerr << "Failed to build dialogue tree!" << endl;
        }
    }
    cout << "InGameState constructor end" << endl;
}

InGameState::InGameState(GameEngine& game, const string& startNodeId)
    : GameState(game),
      dialogueVisitor(game.getWindow()),
      currentDialogueNode(nullptr),
      currentNodeId(startNodeId),
      showMenu(false),
      hoveredButton(-1) {

    if (!uiFont.openFromFile("assets/arial.ttf")) {
        cerr << "Error loading UI font" << endl;
    }

    // Create text objects with font
    saveButtonText = new sf::Text(uiFont);
    loadButtonText = new sf::Text(uiFont);
    exitButtonText = new sf::Text(uiFont);
    backButtonText = new sf::Text(uiFont);

    sf::Vector2u windowSize = game.getWindow().getSize();
    float buttonWidth = 80.0f;
    float buttonHeight = 35.0f;
    float buttonMargin = 10.0f;
    float topMargin = 10.0f;

    // Back button (leftmost) - Uses Stack for undo
    backButton.setSize({buttonWidth, buttonHeight});
    backButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 4, topMargin});
    backButton.setFillColor(sf::Color(100, 80, 140, 200));
    backButton.setOutlineColor(sf::Color(150, 120, 200));
    backButton.setOutlineThickness(2);
    backButtonText->setString(to_sf_string_ingame("Back"));
    backButtonText->setCharacterSize(18);
    backButtonText->setFillColor(sf::Color::White);
    backButtonText->setPosition({backButton.getPosition().x + 20, backButton.getPosition().y + 7});

    saveButton.setSize({buttonWidth, buttonHeight});
    saveButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 3, topMargin});
    saveButton.setFillColor(sf::Color(60, 100, 140, 200));
    saveButton.setOutlineColor(sf::Color(100, 150, 200));
    saveButton.setOutlineThickness(2);
    saveButtonText->setString(to_sf_string_ingame("Save"));
    saveButtonText->setCharacterSize(18);
    saveButtonText->setFillColor(sf::Color::White);
    saveButtonText->setPosition({saveButton.getPosition().x + 20, saveButton.getPosition().y + 7});

    loadButton.setSize({buttonWidth, buttonHeight});
    loadButton.setPosition({windowSize.x - (buttonWidth + buttonMargin) * 2, topMargin});
    loadButton.setFillColor(sf::Color(60, 100, 140, 200));
    loadButton.setOutlineColor(sf::Color(100, 150, 200));
    loadButton.setOutlineThickness(2);
    loadButtonText->setString(to_sf_string_ingame("Load"));
    loadButtonText->setCharacterSize(18);
    loadButtonText->setFillColor(sf::Color::White);
    loadButtonText->setPosition({loadButton.getPosition().x + 20, loadButton.getPosition().y + 7});

    exitButton.setSize({buttonWidth, buttonHeight});
    exitButton.setPosition({windowSize.x - (buttonWidth + buttonMargin), topMargin});
    exitButton.setFillColor(sf::Color(140, 60, 60, 200));
    exitButton.setOutlineColor(sf::Color(200, 100, 100));
    exitButton.setOutlineThickness(2);
    exitButtonText->setString(to_sf_string_ingame("Exit"));
    exitButtonText->setCharacterSize(18);
    exitButtonText->setFillColor(sf::Color::White);
    exitButtonText->setPosition({exitButton.getPosition().x + 23, exitButton.getPosition().y + 7});

    dialogueVisitor.setTextSpeed(game.getSettings().getTextSpeedMultiplier());
    dialogueVisitor.setPlayer(&game.getPlayer());

    auto* dialogueGraph = game.getDialogueGraph();
    if (dialogueGraph) {
        dialogueGraph->setDialogueStartCallback([this](NTree<Dialogue, MAX_CHOICES>* node) {
            if (node && !node->isEmpty()) {
                currentDialogueNode = node;
                currentDialogueNode->getKey().accept(dialogueVisitor);
            } else {
                currentDialogueNode = nullp
